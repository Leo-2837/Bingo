<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Real‚ÄëLife Bingo 2.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- (Optional, wird lokal per file:// meist ignoriert; bei Hosting aktiv) -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root {
    --bg1: #6a11cb;
    --bg2: #2575fc;
    --tile: rgba(255,255,255,0.18);
    --tile-marked: #00c853;

    /* NEU: responsive Zellengr√∂√üe */
    --cell: 70px;
    --gap: 8px;
  }

  body {
    font-family: "Helvetica", system-ui, -apple-system, Arial, sans-serif;
    margin: 0;
    min-height: 100dvh;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: #fff;
    text-align: center;
    padding: 16px;
  }

  h1 { margin: 6px 0 10px; font-size: clamp(20px, 5vw, 26px); }

  #board {
    display: grid;
    gap: var(--gap);
    justify-content: center;
    margin: 18px auto 24px;
  }

  .cell {
    width: var(--cell);
    height: var(--cell);
    background: var(--tile);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
    font-size: clamp(12px, calc(var(--cell) * 0.22), 18px);
    text-align: center;
    word-break: break-word;
    cursor: pointer;
    transition: transform .15s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.22);
    color: #fff;
  }

  .cell:active { transform: scale(0.98); }

  .marked {
    background: var(--tile-marked) !important;
    color: #fff;
    text-decoration: line-through;
  }

  input {
    width: 92%;
    border-radius: 10px;
    border: none;
    padding: 6px 8px;
    text-align: center;
    font-size: clamp(12px, calc(var(--cell) * 0.18), 16px);
    outline: none;
    background: rgba(255,255,255,0.92);
    color: #222;
  }

  .toolbar { margin: 8px 0 2px; }

  button, select {
    margin: 6px 6px 0;
    padding: 12px 18px;
    border: none;
    border-radius: 12px;
    background: #fff;
    color: #333;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 3px 8px rgba(0,0,0,0.22);
  }

  button:active { transform: scale(0.98); }

  #winMessage {
    position: fixed;
    top: 42%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #00c853;
    color: white;
    padding: 28px 34px;
    border-radius: 14px;
    font-size: 30px;
    display: none;
    z-index: 2000;
  }

  #confetti {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 3000;
    display: none;
  }

  /* Regeln-Bereich */
  details.rules-box {
    background:#ffffff22;
    backdrop-filter:blur(6px);
    padding:10px 14px;
    border-radius:10px;
    margin:15px auto;
    max-width:400px;
    text-align:left;
  }
</style>
</head>

<body>

<canvas id="confetti"></canvas>

<h1>Juha Bingo</h1>

<details class="rules-box">
  <summary style="font-size:18px;font-weight:700;cursor:pointer;margin:0 0 8px 0;">
    ‚ÑπÔ∏è Regeln anzeigen
  </summary>
  <ul style="padding-left:20px; font-size:15px; line-height:1.4;">
    <li>Das Spiel beginnt, sobald dein Feld fertig erstellt ist.</li>
    <li>Gewonnen hat, wer 5 Felder in einer Linie erf√ºllt (waagerecht, senkrecht, diagonal).</li>
    <li>Der Sieg z√§hlt erst, wenn er laut angesagt wird.</li>
    <li>Man darf sich selbst nicht in ein Feld schreiben.</li>
    <li>Auff√§lliges Antworten erzwingen z√§hlt nicht.</li>
    <li>Unerf√ºllbare Felder d√ºrfen als √ò gekennzeichnet werden.</li>
  </ul>
</details>

<div class="toolbar">
  <label for="sizeSelect">Feldgr√∂√üe:</label>
  <select id="sizeSelect">
    <option value="4">4√ó4</option>
    <option value="5" selected>5√ó5</option>
  </select>
</div>

<div class="toolbar">
  <button id="startBtn">Start</button>
  <button id="editBtn">Bearbeiten</button>
  <button id="resetBtn">Reset</button>
</div>

<div id="board"></div>

<div id="winMessage">BINGO! üéâ</div>

<script>
/* ----------- RESPONSIVES CELL-SYSTEM ----------- */
function updateCellSize() {
  const cols = parseInt(sizeSelect.value || "5", 10);
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  const reservedTopBottom = 190;  // Titel + Buttons + Regeln
  const maxW = vw - 32;           // etwas Rand
  const maxH = vh - reservedTopBottom;

  const gap = 8;
  const cellByWidth = (maxW - gap * (cols - 1)) / cols;
  const cellByHeight = (maxH - gap * (cols - 1)) / cols;

  const cell = Math.floor(Math.min(cellByWidth, cellByHeight));
  const clamped = Math.max(50, Math.min(cell, 110));

  document.documentElement.style.setProperty('--cell', clamped + "px");
  board.style.gridTemplateColumns = `repeat(${cols}, var(--cell))`;
}

/* ----------- ORIGINAL CODE (minimal angepasst) ----------- */

let editing = true;
let winMessageTimeout = null;

// Konfetti
let confettiRAF = null;
let confettiRunning = false;
const confettiCanvas = document.getElementById('confetti');
const ctx = confettiCanvas.getContext('2d');

// DOM
const sizeSelect = document.getElementById('sizeSelect');
const board      = document.getElementById('board');
const editBtn    = document.getElementById('editBtn');
const startBtn   = document.getElementById('startBtn');
const resetBtn   = document.getElementById('resetBtn');
const winMessage = document.getElementById('winMessage');

/* SAFARI / FILE-VORSCHAU ROBUST */
document.addEventListener('DOMContentLoaded', safeInit);
let earlyInitRun = false;

function safeInit() {
  try {
    const savedSize = localStorage.getItem("bingoSize");
    if (savedSize) sizeSelect.value = savedSize;

    generateBoard();

    const saved = JSON.parse(localStorage.getItem("bingoCells") || "null");
    if (saved && Array.isArray(saved.cells)) {
      loadBoardFromData(saved);
      if (saved.mode === "play") setPlayMode();
    }

    window.addEventListener('resize', () => {
      fitCanvas();
      updateCellSize();
    });

    sizeSelect.addEventListener('change', () => {
      localStorage.setItem("bingoSize", sizeSelect.value);
      generateBoard();
      autoSave();
    });

    startBtn.addEventListener('click', startGame);
    editBtn.addEventListener('click', toggleEdit);
    resetBtn.addEventListener('click', resetBoard);
  } catch(e) {}
}

/* -------- BOARD -------- */
function generateBoard() {
  stopWinEffects();

  updateCellSize(); // <<< WICHTIG: Responsive Berechnung

  const size = parseInt(sizeSelect.value || "5", 10);
  board.innerHTML = "";

  for (let i = 0; i < size * size; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';

    const input = document.createElement('input');
    input.placeholder = "Text‚Ä¶";
    input.addEventListener('input', autoSave);

    cell.appendChild(input);
    board.appendChild(cell);
  }

  editing = true;
  editBtn.textContent = "Weiter spielen";
}

function startGame() {
  setPlayMode();
  autoSave();
}

function setPlayMode() {
  editing = false;
  editBtn.textContent = "Bearbeiten";

  document.querySelectorAll('.cell').forEach(cell => {
    const input = cell.querySelector('input');
    const txt = input ? input.value : cell.textContent;
    cell.textContent = txt;
    if (input) input.remove();
    cell.onclick = () => markCell(cell);
  });
}

function toggleEdit() {
  editing = !editing;
  editBtn.textContent = editing ? "Weiter spielen" : "Bearbeiten";

  document.querySelectorAll('.cell').forEach(cell => {
    const currentText = cell.textContent;
    cell.onclick = null;

    if (editing) {
      cell.classList.remove('marked');
      cell.textContent = "";
      const input = document.createElement('input');
      input.value = currentText;
      input.addEventListener('input', autoSave);
      cell.appendChild(input);
    } else {
      const input = cell.querySelector('input');
      const txt = input ? input.value : currentText;
      if (input) input.remove();
      cell.textContent = txt;
      cell.onclick = () => markCell(cell);
    }
  });

  stopWinEffects();
  autoSave();
}

function markCell(cell) {
  if (editing) return;
  cell.classList.toggle('marked');
  checkWin();
  autoSave();
}

/* -------- Gewinnpr√ºfung -------- */
function checkWin() {
  const size = parseInt(sizeSelect.value || "5", 10);
  const cellsFlat = Array.from(document.querySelectorAll('.cell'));
  const grid = [];
  for (let i = 0; i < cellsFlat.length; i += size) {
    grid.push(cellsFlat.slice(i, i + size));
  }

  for (let r = 0; r < size; r++)
    if (grid[r].every(c => c.classList.contains('marked'))) return showWin();

  for (let c = 0; c < size; c++)
    if (grid.every(row => row[c].classList.contains('marked'))) return showWin();

  if (grid.every((row,i)=>row[i].classList.contains('marked'))) return showWin();
  if (grid.every((row,i)=>row[size-i-1].classList.contains('marked'))) return showWin();
}

/* -------- Sieg -------- */
function showWin() {
  winMessage.style.display = 'block';
  if (winMessageTimeout) clearTimeout(winMessageTimeout);
  winMessageTimeout = setTimeout(() => winMessage.style.display='none', 1800);
  startConfetti(1600);
}

/* Konfetti */
function startConfetti(durationMs=1500){
  if (confettiRunning) stopConfetti();
  confettiRunning=true;
  confettiCanvas.style.display='block';
  fitCanvas();

  const pieces=[];
  for(let i=0;i<180;i++){
    pieces.push({
      x:Math.random()*confettiCanvas.width,
      y:Math.random()*-confettiCanvas.height,
      vx:-1+Math.random()*2,
      vy:2+Math.random()*4,
      r:2+Math.random()*4,
      color:`hsl(${Math.random()*360},100%,50%)`
    });
  }

  const end=performance.now()+durationMs;

  function frame(now){
    ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    pieces.forEach(p=>{
      p.x+=p.vx;
      p.y+=p.vy;
      if(p.y>confettiCanvas.height){
        p.y=-5; p.x=Math.random()*confettiCanvas.width;
      }
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=p.color;
      ctx.fill();
    });

    if(now<end) confettiRAF=requestAnimationFrame(frame);
    else stopConfetti();
  }

  confettiRAF=requestAnimationFrame(frame);
}

function stopConfetti(){
  if(confettiRAF) cancelAnimationFrame(confettiRAF);
  confettiRAF=null;
  confettiRunning=false;
  ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  confettiCanvas.style.display='none';
}

function stopWinEffects(){
  stopConfetti();
  if(winMessageTimeout) clearTimeout(winMessageTimeout);
  winMessageTimeout=null;
  winMessage.style.display='none';
}

function fitCanvas(){
  confettiCanvas.width=window.innerWidth;
  confettiCanvas.height=window.innerHeight;
}

/* -------- Autosave -------- */
function autoSave(){
  const data={
    size:parseInt(sizeSelect.value||"5",10),
    mode:editing?"edit":"play",
    cells:[]
  };
  document.querySelectorAll('.cell').forEach(cell=>{
    const input=cell.querySelector('input');
    data.cells.push({
      text:input?input.value:cell.textContent,
      marked:cell.classList.contains('marked')
    });
  });

  localStorage.setItem("bingoSize",String(data.size));
  localStorage.setItem("bingoCells",JSON.stringify(data));
}

/* gespeicherte Felder laden */
function loadBoardFromData(saved){
  const cells=document.querySelectorAll('.cell');
  saved.cells.forEach((c,i)=>{
    const cell=cells[i];
    if(!cell) return;

    if(editing){
      const input=cell.querySelector('input');
      if(input) input.value=c.text||"";
    } else {
      cell.textContent=c.text||"";
      if(c.marked) cell.classList.add('marked');
      else cell.classList.remove('marked');
    }
  });
}

/* -------- RESET: Speicher leeren + neu aufbauen -------- */
function resetBoard(){
  // Laufende Effekte beenden
  stopWinEffects();

  // Persistente Daten l√∂schen
  try {
    localStorage.removeItem("bingoCells");
    localStorage.removeItem("bingoSize");
  } catch(e){}

  // Wenn du beim Reset immer 5√ó5 m√∂chtest, entkommentiere die n√§chste Zeile:
  // sizeSelect.value = "5";

  // Gr√∂√üe neu berechnen & frisches Board erzeugen
  updateCellSize();
  generateBoard();
}

/* Sofort-Init f√ºr harte iPhone-F√§lle */
if(!earlyInitRun){
  earlyInitRun=true;
  generateBoard();
}
</script>

<script type="module">
  // Wir importieren Firebase erneut (ist erlaubt)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, update, onValue, get, child }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // Deine Config erneut ‚Äì kein Problem
  const firebaseConfig = {
    apiKey: "AIzaSyACvAtQUjfLcXrf9IFvzbkjZJNuvKdTxxA",
    authDomain: "juha-bingo.firebaseapp.com",
    databaseURL: "https://juha-bingo-default-rtdb.firebaseio.com",
    projectId: "juha-bingo",
    storageBucket: "juha-bingo.firebasestorage.app",
    messagingSenderId: "231171590379",
    appId: "1:231171590379:web:97cc31704cd5228c3916ae",
    measurementId: "G-DM99GR9Z57"
  };

  // Zweite Firebase-Instanz initialisieren (keine Konflikte)
  const app2 = initializeApp(firebaseConfig, "multiplayer");
  const db   = getDatabase(app2);


  /* =========================================================
     Multiplayer UI einf√ºgen
     ========================================================= */

  const uiHTML = `
    <div class="toolbar" style="margin-top:12px;">
      <input id="mp_name" placeholder="Dein Name" style="max-width:140px;">
      <button id="mp_create">Match erstellen</button>
      <input id="mp_code" placeholder="Raumcode" style="max-width:120px;">
      <button id="mp_join">Beitreten</button>
    </div>

    <div class="toolbar">
      <span id="mp_status" style="font-weight:700;"></span>
    </div>

    <div class="toolbar">
      <label>Gegner ansehen:</label>
      <select id="mp_opponents"><option value="">‚Äî</option></select>
    </div>

    <h2>Gegner-Board</h2>
    <div id="mp_enemy" 
      style="display:grid;gap:var(--gap);justify-content:center;margin-bottom:20px;">
    </div>
  `;

  // UI einf√ºgen
  document.body.insertAdjacentHTML("beforeend", uiHTML);


  /* =========================================================
     Variablen & DOM
     ========================================================= */

  const nameInput = document.getElementById("mp_name");
  const codeInput = document.getElementById("mp_code");
  const joinBtn   = document.getElementById("mp_join");
  const createBtn = document.getElementById("mp_create");
  const statusLbl = document.getElementById("mp_status");
  const oppSelect = document.getElementById("mp_opponents");
  const enemyDiv  = document.getElementById("mp_enemy");

  let ROOM = null;
  let PLAYER = null;
  let unsubOpp = null;


  /* =========================================================
     Hilfsfunktionen
     ========================================================= */

  function randomCode() {
    const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s = "";
    for (let i=0;i<6;i++) s += c[Math.floor(Math.random()*c.length)];
    return s;
  }

  function setStatus(msg) {
    statusLbl.textContent = msg;
  }


  /* =========================================================
     Raum erstellen
     ========================================================= */

  createBtn.onclick = async () => {
    PLAYER = nameInput.value.trim() || "Spieler" + Math.floor(Math.random()*1000);
    ROOM = randomCode();

    await set(ref(db, `rooms/${ROOM}`), {
      created: Date.now(),
      maxPlayers: 4
    });

    setStatus(`Raum erstellt: ${ROOM}`);
    codeInput.value = ROOM;

    joinRoom();
  };


  /* =========================================================
     Raum beitreten
     ========================================================= */

  joinBtn.onclick = () => {
    PLAYER = nameInput.value.trim() || "Spieler" + Math.floor(Math.random()*1000);
    ROOM = codeInput.value.trim().toUpperCase();
    joinRoom();
  };


  async function joinRoom() {
    if (!ROOM) return alert("Kein Raumcode!");

    await update(ref(db, `rooms/${ROOM}/players/${PLAYER}`), {
      joined: Date.now()
    });

    setStatus(`Verbunden als ${PLAYER} in ${ROOM}`);

    // Gegnerliste beobachten
    onValue(ref(db, `rooms/${ROOM}/players`), snap => {
      const players = snap.val() || {};
      oppSelect.innerHTML = `<option value="">‚Äî</option>`;
      Object.keys(players).forEach(p => {
        if (p !== PLAYER) {
          oppSelect.innerHTML += `<option value="${p}">${p}</option>`;
        }
      });
    });
  }


  /* =========================================================
     Eigenes Board speichern
     ========================================================= */

  function saveBoard() {
    if (!ROOM || !PLAYER) return;

    const size = parseInt(sizeSelect.value);
    const cells = [...document.querySelectorAll(".cell")];

    const payload = {};
    cells.forEach((cell, i) => {
      const input = cell.querySelector("input");
      payload[i] = {
        text: input ? input.value : cell.textContent,
        marked: cell.classList.contains("marked")
      };
    });

    update(ref(db, `rooms/${ROOM}/players/${PLAYER}`), {
      size,
      board: payload
    });
  }

  // Hooks in bestehende Funktionen
  const oldAuto = window.autoSave;
  window.autoSave = function() {
    oldAuto();
    saveBoard();
  };

  const oldMark = window.markCell;
  window.markCell = function(cell) {
    oldMark(cell);
    saveBoard();
  };


  /* =========================================================
     Gegnerboard anzeigen
     ========================================================= */

  oppSelect.onchange = () => {
    if (unsubOpp) unsubOpp();
    enemyDiv.innerHTML = "";

    const enemy = oppSelect.value;
    if (!enemy) return;

    unsubOpp = onValue(ref(db, `rooms/${ROOM}/players/${enemy}/board`), snap => {
      const board = snap.val();
      renderEnemy(board);
    });
  };

  function renderEnemy(board) {
    const size = parseInt(sizeSelect.value);
    enemyDiv.style.gridTemplateColumns = `repeat(${size}, var(--cell))`;
    enemyDiv.innerHTML = "";

    for (let i=0;i<size*size;i++) {
      const d = board?.[i] || { text:"", marked:false };
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.textContent = d.text;
      if (d.marked) cell.classList.add("marked");
      enemyDiv.appendChild(cell);
    }
  }
</script>
</body>
</html>